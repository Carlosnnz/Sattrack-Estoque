{% extends "base.html" %}
{% block title %}Inventário{% endblock %}
{% block content %}
<div class="card">
        <div class="card-header">Filtro</div>
        <form method="get" action="/inventario" class="filters-grid">
            <label>Código<input name="codigo" value="{{ filtro_codigo }}"></label>
            <label>Descrição<input name="descricao" value="{{ filtro_descricao }}"></label>
            <label>Categoria
                <select name="categoria">
                    <option value="">Todas</option>
                    {% for cat in categorias %}
                        <option value="{{ cat }}" {% if filtro_categoria == cat %}selected{% endif %}>{{ cat }}</option>
                    {% endfor %}
                </select>
            </label>
            <div class="inline-actions">
                <button class="btn" type="submit">Buscar</button>
                <a class="btn secondary" href="/inventario">Limpar</a>
            </div>
        </form>
</div>

<div class="grid two">
    <div class="card">
        {% if erro %}
            <div class="alert danger">
                {% if erro == 'codigo' %}
                    Código interno já existe.
                {% elif erro == 'item_relacionado' %}
                    Não é possível excluir: existem movimentações (entradas/saídas/transferências) vinculadas a este item.
                    {% if item_relacionado %}
                        <div style="margin-top:8px;">
                            <strong>Item:</strong> {{ item_relacionado.descricao }} ({{ item_relacionado.codigo_interno }})
                        </div>
                        <form method="post" action="/items/{{ item_relacionado.id }}/deletar" style="margin-top:8px;" onsubmit="return confirm('Excluir item e APAGAR todas as movimentacoes vinculadas?');">
                            <input type="hidden" name="force" value="1">
                            <button class="btn danger" type="submit">Excluir mesmo assim</button>
                        </form>
                    {% endif %}
                {% else %}
                    Ocorreu um erro ao processar sua solicitação.
                {% endif %}
            </div>
        {% endif %}
        <div class="card-header">Cadastrar Item</div>
        <form method="post" action="/inventario/cadastrar" enctype="multipart/form-data" class="form-grid">
            <label>Código Interno<input name="codigo_interno" required></label>
            <label>Descrição<input name="descricao" required></label>
            <label>Categoria
                <select name="categoria">
                    <option value="">Selecione</option>
                    {% for cat in categorias %}
                        <option value="{{ cat }}">{{ cat }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>Quantidade<input type="number" name="quantidade" min="0" value="0"></label>
            <label>Valor Unitário<input type="number" step="0.01" name="valor_unitario" value="0.00" required></label>
            <label>Localização<input name="localizacao"></label>
            <label>Observação<textarea name="observacao" placeholder="Opcional"></textarea></label>
            <label>Foto<input type="file" name="foto" accept=".jpg,.jpeg,.png"></label>
            <button class="btn" type="submit">Salvar</button>
        </form>
    </div>
    <div class="card">
        <div class="card-header">Itens</div>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th></th><th>Foto</th><th>Código</th><th>Descrição</th><th>Categoria</th><th>Qtd</th><th>Valor</th><th>Local</th><th>Observação</th><th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                {% for item in itens %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{% if item.foto %}<img src="{{ item.foto }}" class="small-avatar" alt="foto">{% else %}-{% endif %}</td>
                        <td>{{ item.codigo_interno }}</td>
                        <td>{{ item.descricao }}</td>
                        <td>{{ item.categoria }}</td>
                        <td>{{ item.quantidade }}</td>
                        <td>R$ {{ "%.2f"|format(item.valor_unitario) }}</td>
                        <td>{{ item.localizacao }}</td>
                        <td>{{ item.observacao or '-' }}</td>
                        <td>
                            <details>
                                <summary>Editar</summary>
                                <form method="post" action="/items/{{ item.id }}/editar" enctype="multipart/form-data" class="form-grid">
                                    <input name="descricao" value="{{ item.descricao }}" required>
                                    <select name="categoria">
                                        <option value="">Selecione</option>
        {% for cat in categorias %}
            <option value="{{ cat }}" {% if item.categoria==cat %}selected{% endif %}>{{ cat }}</option>
        {% endfor %}
                                    </select>
                                    <input type="number" name="quantidade" value="{{ item.quantidade }}" required>
                                    <input type="number" step="0.01" name="valor_unitario" value="{{ item.valor_unitario }}" required>
                                    <input name="localizacao" value="{{ item.localizacao }}">
                                    <textarea name="observacao" placeholder="Opcional">{{ item.observacao or '' }}</textarea>
                                    <input type="file" name="foto" accept=".jpg,.jpeg,.png">
                                    <button class="btn" type="submit">Salvar</button>
                                </form>
                                <form method="post" action="/items/{{ item.id }}/deletar" onsubmit="return confirm('Excluir item?');">
                                    <button class="btn danger" type="submit">Excluir</button>
                                </form>
                            </details>
                        </td>
                    </tr>
                {% else %}
                    <tr><td colspan="8">Nenhum item cadastrado.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
