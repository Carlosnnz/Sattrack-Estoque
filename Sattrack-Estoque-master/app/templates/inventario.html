{% extends "base.html" %}
{% block title %}Inventário{% endblock %}
{% block content %}
<div class="inventory-page">
    <div class="card toolbar-card">
        <div class="toolbar-heading">
            <div>
                <p class="eyebrow">Filtro rápido</p>
                <h3>Inventário</h3>
            </div>
            <div class="pill ghost">Total: {{ total }} itens</div>
        </div>
        <form method="get" action="/inventario" class="filter-toolbar">
            <div class="input-chip">
                <i class="fi fi-rr-barcode icon"></i>
                <input name="codigo" value="{{ filtro_codigo }}" placeholder="Código">
            </div>
            <div class="input-chip grow">
                <i class="fi fi-rr-search icon"></i>
                <input name="descricao" value="{{ filtro_descricao }}" placeholder="Descrição">
            </div>
            <div class="input-chip select-chip">
                <i class="fi fi-rr-box icon"></i>
                <select name="categoria">
                    <option value="">Todas as categorias</option>
                    {% for cat in categorias %}
                        <option value="{{ cat }}" {% if filtro_categoria == cat %}selected{% endif %}>{{ cat }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="toolbar-actions">
                <button class="btn ghost-btn" type="submit"><i class="fi fi-rr-search"></i><span>Buscar</span></button>
                <a class="btn tertiary" href="/inventario"><i class="fi fi-rr-refresh"></i><span>Limpar</span></a>
            </div>
        </form>
    </div>

    <div class="grid two inventory-grid">
        <div class="card elevated">
            {% if erro %}
                <div class="alert error">
                    {% if erro == 'codigo' %}
                        Código interno já existe.
                    {% elif erro == 'item_relacionado' %}
                        Não é possível excluir: existem movimentações (entradas/saídas/transferências) vinculadas a este item.
                        {% if item_relacionado %}
                            <div class="alert-note">
                                <strong>Item:</strong> {{ item_relacionado.descricao }} ({{ item_relacionado.codigo_interno }})
                            </div>
                            <form method="post" action="/items/{{ item_relacionado.id }}/deletar" onsubmit="return confirm('Excluir item e apagar todas as movimentações vinculadas?');">
                                <input type="hidden" name="force" value="1">
                                <button class="btn danger" type="submit">Excluir mesmo assim</button>
                            </form>
                        {% endif %}
                    {% else %}
                        Ocorreu um erro ao processar sua solicitação.
                    {% endif %}
                </div>
            {% endif %}
            <div class="card-header spaced">
                <div>
                    <p class="eyebrow">Cadastro</p>
                    <h3>Novo item</h3>
                </div>
                <div class="pill blue">Registro rápido</div>
            </div>
            <form method="post" action="/inventario/cadastrar" enctype="multipart/form-data" class="inventory-form">
                <label>Código Interno<input name="codigo_interno" required placeholder="EX: SAT-1001"></label>
                <label>Descrição<input name="descricao" required placeholder="Notebook Dell 3520"></label>
                <label>Categoria
                    <select name="categoria">
                        <option value="">Selecione</option>
                        {% for cat in categorias %}
                            <option value="{{ cat }}">{{ cat }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label>Quantidade<input type="number" name="quantidade" min="0" value="0" placeholder="0"></label>
                <label>Valor Unitário<input type="number" step="0.01" name="valor_unitario" value="0.00" required placeholder="0,00"></label>
                <label>Localização<input name="localizacao" placeholder="Ex: Almoxarifado A1"></label>
                <label class="span-2">Observação<textarea name="observacao" placeholder="Opcional"></textarea></label>
                <div class="dropzone">
                    <i class="fi fi-rr-picture"></i>
                    <div>
                        <strong>Upload de foto</strong>
                        <p>Arraste ou selecione um arquivo .jpg, .jpeg ou .png</p>
                    </div>
                    <input type="file" name="foto" accept=".jpg,.jpeg,.png">
                </div>
                <div class="form-actions">
                    <button class="btn" type="submit"><i class="fi fi-rr-check"></i><span>Salvar item</span></button>
                </div>
            </form>
        </div>

        <div class="card elevated inventory-card">
            <div class="card-header spaced">
                <div>
                    <p class="eyebrow">Itens</p>
                    <h3>Lista do inventário</h3>
                </div>
                <div class="pill ghost">{{ total }} itens</div>
            </div>
            <div class="table-responsive inventory-table">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Foto</th>
                            <th>Código</th>
                            <th>Descrição</th>
                            <th>Categoria</th>
                            <th>Qtd</th>
                            <th>Valor</th>
                            <th>Local</th>
                            <th>Obs</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for item in itens %}
                        {% set low_stock = item.quantidade is not none and item.quantidade <= 1 %}
                        <tr class="row-link">
                            <td>{{ start + loop.index0 + 1 }}</td>
                            <td class="avatar-cell">{% if item.foto %}<img src="{{ item.foto }}" class="small-avatar" alt="foto">{% else %}<div class="avatar placeholder"><i class="fi fi-rr-picture"></i></div>{% endif %}</td>
                            <td class="mono">{{ item.codigo_interno }}</td>
                            <td>{{ item.descricao }}</td>
                            <td><span class="pill ghost">{{ item.categoria }}</span></td>
                            <td><span class="pill {{ 'danger' if low_stock else 'blue' }}">{{ item.quantidade }}</span></td>
                            <td class="mono">R$ {{ "%.2f"|format(item.valor_unitario) }}</td>
                            <td>{{ item.localizacao }}</td>
                            <td class="muted">{{ item.observacao or '-' }}</td>
                            <td class="actions">
                                <details class="row-actions">
                                    <summary title="Editar item"><i class="fi fi-rr-edit"></i></summary>
                                    <form method="post" action="/items/{{ item.id }}/editar" enctype="multipart/form-data" class="form-grid compact">
                                        <input name="descricao" value="{{ item.descricao }}" required>
                                        <select name="categoria">
                                            <option value="">Selecione</option>
                                            {% for cat in categorias %}
                                                <option value="{{ cat }}" {% if item.categoria==cat %}selected{% endif %}>{{ cat }}</option>
                                            {% endfor %}
                                        </select>
                                        <input type="number" name="quantidade" value="{{ item.quantidade }}" required>
                                        <input type="number" step="0.01" name="valor_unitario" value="{{ item.valor_unitario }}" required>
                                        <input name="localizacao" value="{{ item.localizacao }}">
                                        <textarea name="observacao" placeholder="Opcional">{{ item.observacao or '' }}</textarea>
                                        <input type="file" name="foto" accept=".jpg,.jpeg,.png">
                                        <button class="btn" type="submit">Salvar</button>
                                    </form>
                                    <form method="post" action="/items/{{ item.id }}/deletar" onsubmit="return confirm('Excluir item?');">
                                        <button class="btn danger" type="submit">Excluir</button>
                                    </form>
                                </details>
                            </td>
                        </tr>
                    {% else %}
                        <tr><td colspan="10">Nenhum item cadastrado.</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="pagination modern">
                {% set prev_page = page - 1 %}
                {% set next_page = page + 1 %}
                <a class="page-btn {% if page == 1 %}disabled{% endif %}" {% if page > 1 %}href="/inventario?codigo={{ filtro_codigo }}&descricao={{ filtro_descricao }}&categoria={{ filtro_categoria }}&page={{ prev_page }}"{% endif %}>
                    <i class="fi fi-rr-angle-left"></i> Anterior
                </a>
                <span class="page-info strong">Página {{ page }} de {{ total_pages }}</span>
                <a class="page-btn {% if page == total_pages %}disabled{% endif %}" {% if page < total_pages %}href="/inventario?codigo={{ filtro_codigo }}&descricao={{ filtro_descricao }}&categoria={{ filtro_categoria }}&page={{ next_page }}"{% endif %}>
                    Próxima <i class="fi fi-rr-angle-right"></i>
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
