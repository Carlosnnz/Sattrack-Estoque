{% extends "base.html" %}
{% block title %}Analise de Valores de Produtos{% endblock %}
{% block content %}
{% set color_map = {"low": "#16a34a", "mid": "#facc15", "high": "#dc2626", "na": "#e5e7eb"} %}
{% set text_map = {"low": "#ffffff", "mid": "#1f2937", "high": "#ffffff", "na": "#374151"} %}
<div class="analysis-page">
    <div class="card toolbar-card">
        <div class="toolbar-heading">
            <div>
                <p class="eyebrow">Filtro rapido</p>
                <h3>Analise de valores</h3>
            </div>
            <div class="pill ghost">Itens: {{ linhas|length }}</div>
        </div>
        <form method="get" action="/analise-valores" class="filter-toolbar">
            <div class="input-chip select-chip">
                <i class="fi fi-rr-box"></i>
                <select name="categoria">
                    <option value="">Categoria</option>
                    {% for c in categorias_options %}
                        <option value="{{ c }}" {% if c==filtro_categoria %}selected{% endif %}>{{ c }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="input-chip select-chip">
                <i class="fi fi-rr-settings"></i>
                <select name="tipo">
                    <option value="">Tipo</option>
                    {% for t in tipos_options %}
                        <option value="{{ t }}" {% if t==filtro_tipo %}selected{% endif %}>{{ t }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="input-chip grow">
                <i class="fi fi-rr-briefcase"></i>
                <input name="fornecedor" value="{{ filtro_fornecedor }}" placeholder="Fornecedor">
            </div>
            <div class="toolbar-actions">
                <button class="btn ghost-btn" type="submit"><i class="fi fi-rr-search"></i><span>Filtrar</span></button>
                <a class="btn tertiary" href="/analise-valores"><i class="fi fi-rr-refresh"></i><span>Limpar</span></a>
            </div>
        </form>
    </div>

    <div class="grid two analysis-grid">
        <div class="card elevated">
            <div class="card-header spaced">
                <div>
                    <p class="eyebrow">Adicionar</p>
                    <h3>Item (peca)</h3>
                </div>
                <div class="pill blue">Novo</div>
            </div>
            <form action="/analise-valores/itens/criar" method="post" class="analysis-form">
                <label>Peca
                    <input name="nome" required placeholder="Ex: SSD NVMe 1TB">
                </label>
                <label>Quantidade
                    <input type="number" name="quantidade" min="1" value="1" required>
                </label>
                <label>Categoria
                    <input name="categoria" placeholder="Hardware, Periferico...">
                </label>
                <label>Tipo
                    <input name="tipo" placeholder="Processador, Memoria...">
                </label>
                <label class="span-2">Especificacoes
                    <textarea name="especificacao" placeholder="Modelo, voltagem, compatibilidade"></textarea>
                </label>
                <div class="form-actions">
                    <button class="btn" type="submit"><i class="fi fi-rr-check"></i><span>Salvar item</span></button>
                </div>
            </form>
        </div>
        <div class="card elevated">
            <div class="card-header spaced">
                <div>
                    <p class="eyebrow">Adicionar</p>
                    <h3>Valor por fornecedor</h3>
                </div>
                <div class="pill ghost">Cotacao</div>
            </div>
            <form action="/analise-valores/valores/criar" method="post" enctype="multipart/form-data" class="analysis-form">
                <label>Fornecedor
                    <select name="fornecedor_id" required>
                        <option value="">Selecione</option>
                        {% for f in fornecedores_base %}
                            <option value="{{ f.id }}">{{ f.nome }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label>Item
                    <select name="item_id" required>
                        <option value="">Selecione</option>
                        {% for i in itens %}
                            <option value="{{ i.id }}">{{ i.nome }} ({{ i.quantidade }})</option>
                        {% endfor %}
                    </select>
                </label>
                <label>Valor unitario
                    <input type="text" name="valor_unitario" placeholder="Ex: 529,00" required>
                </label>
                <label class="span-2">Observacao
                    <textarea name="observacao" placeholder="Prazo, frete, forma de pagamento..."></textarea>
                </label>
                <div class="upload-inline span-2">
                    <div class="dropzone compact">
                        <i class="fi fi-rr-file-upload"></i>
                        <div>
                            <strong>Anexar documento</strong>
                            <p>PDF, JPG ou PNG</p>
                        </div>
                        <input type="file" name="documento" accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                    <div class="form-actions right">
                        <button class="btn" type="submit"><i class="fi fi-rr-check"></i><span>Salvar valor</span></button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="card elevated">
        <div class="card-header spaced">
            <div>
                <p class="eyebrow">Resumo geral</p>
                <h3>Valores por fornecedor</h3>
            </div>
            <div class="legend">
                <span class="dot low"></span> Menor | <span class="dot mid"></span> Medio | <span class="dot high"></span> Maior | <span class="dot na"></span> Sem preco
            </div>
        </div>
        <div class="summary-grid">
            {% for f in fornecedores %}
            <div class="summary-card">
                <div class="supplier-avatar">{{ f.nome[:1] }}</div>
                <div class="summary-body">
                    <p class="muted">{{ f.nome }}</p>
                    <div class="summary-value">{{ total_por_fornecedor.get(f.id, 0)|real }}</div>
                    <p class="summary-sub">{% if fornecedor_tem_preco.get(f.id) %}Com precos{% else %}Sem precos{% endif %}</p>
                </div>
            </div>
            {% else %}
            <p>Nenhum fornecedor cadastrado.</p>
            {% endfor %}
        </div>
    </div>

    <div class="card elevated">
        <div class="card-header spaced">
            <div>
                <p class="eyebrow">Comparativo</p>
                <h3>Tabela de precos</h3>
            </div>
            <div class="pill ghost">Itens: {{ linhas|length }}</div>
        </div>
        <div class="table-responsive tabela-comparativa">
            <table class="compare-table compare-modern">
                <thead>
                    <tr class="head-main">
                        <th rowspan="2" class="sticky-col">Peca</th>
                        <th rowspan="2" class="qty-col">Qtd</th>
                        <th rowspan="2" class="spec-col">Especificacoes</th>
                        <th rowspan="2" class="action-col">Acoes</th>
                        {% for f in fornecedores %}
                            <th colspan="2" class="supplier-head">
                                <div class="supplier-header">
                                    <span>{{ f.nome }}</span>
                                </div>
                            </th>
                        {% endfor %}
                    </tr>
                    <tr class="head-sub">
                        {% for f in fornecedores %}
                            <th class="sub-unit">Valor unitario</th>
                            <th class="sub-total">Total</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for linha in linhas %}
                        <tr>
                            <td class="sticky-col">
                                <div class="peca-title">{{ linha.item.nome }}</div>
                            </td>
                            <td class="qty-col">{{ linha.item.quantidade }}</td>
                            <td class="spec-col">{{ linha.item.especificacao or '-' }}</td>
                            <td class="action-col">
                                <form method="post" action="/analise-valores/itens/{{ linha.item.id }}/deletar" onsubmit="return confirm('Excluir esta peca e valores relacionados?');">
                                    <button class="btn danger" type="submit">Excluir</button>
                                </form>
                            </td>
                            {% for cell in linha.cells %}
                                {% set classe = cell.classe or 'na' %}
                                <td class="unit-cell">
                                    <div class="price-chip" style="background: {{ color_map.get(classe, '#e5e7eb') }}; color: {{ text_map.get(classe, '#374151') }};">
                                        {% if cell.valor %}
                                            {{ cell.valor.valor_unitario|real }}
                                        {% else %}
                                            R$ 0,00
                                        {% endif %}
                                    </div>
                                    {% if cell.valor %}
                                        {% if cell.valor.documento %}<div class="cell-meta"><a href="{{ cell.valor.documento }}" target="_blank">Documento</a></div>{% endif %}
                                        {% if cell.valor.observacao %}<div class="cell-meta">{{ cell.valor.observacao }}</div>{% endif %}
                                    {% endif %}
                                </td>
                                <td class="total-cell">
                                    <div class="price-wrapper">
                                        <div class="price-chip" style="background: {{ color_map.get(classe, '#e5e7eb') }}; color: {{ text_map.get(classe, '#374151') }};">
                                            {% if cell.valor %}
                                                {{ cell.valor.valor_total|real }}
                                            {% else %}
                                                R$ 0,00
                                            {% endif %}
                                        </div>
                                        {% if cell.valor %}
                                        <form method="post" action="/analise-valores/valores/{{ cell.valor.id }}/deletar" onsubmit="return confirm('Remover valor?');">
                                            <button class="trash-btn" type="submit" title="Remover valor">
                                                <i class="fi fi-rr-trash"></i>
                                            </button>
                                        </form>
                                        {% endif %}
                                    </div>
                                </td>
                            {% endfor %}
                        </tr>
                    {% else %}
                        <tr><td colspan="{{ fornecedores|length * 2 + 4 }}">Nenhum item cadastrado.</td></tr>
                    {% endfor %}
                    <tr class="total-row">
                        <td class="sticky-col total-label">Total</td>
                        <td class="qty-col total-label">{{ quantidade_total }}</td>
                        <td class="spec-col"></td>
                        <td class="action-col"></td>
                        {% for f in fornecedores %}
                            <td class="unit-cell"></td>
                            <td class="total-cell">
                                {% set classe_total = total_classes.get(f.id, 'na') %}
                                <div class="price-chip" style="background: {{ color_map.get(classe_total, '#e5e7eb') }}; color: {{ text_map.get(classe_total, '#374151') }};">
                                    {{ total_por_fornecedor.get(f.id, 0)|real }}
                                </div>
                            </td>
                        {% endfor %}
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="grid two analysis-grid">
        <div class="card elevated">
            <div class="card-header spaced">
                <div>
                    <p class="eyebrow">Ranking</p>
                    <h3>Fornecedores</h3>
                </div>
            </div>
            {% set max_total = ranking[0].total if ranking else 0 %}
            <ul class="ranking-list">
                {% for item in ranking %}
                    {% set pct = (item.total / max_total * 100) if max_total else 0 %}
                    <li>
                        <div class="rank-row">
                            <span class="rank-number">{{ loop.index }}</span>
                            <div class="rank-info">
                                <div class="rank-name">{{ item.fornecedor.nome }}</div>
                                <div class="rank-bar"><span style="width: {{ pct|round(0, 'floor') }}%"></span></div>
                            </div>
                            <span class="badge soft">{{ item.total|real }}</span>
                        </div>
                    </li>
                {% else %}
                    <li>Nenhum fornecedor informado.</li>
                {% endfor %}
            </ul>
        </div>
        <div class="card elevated">
            <div class="card-header spaced">
                <div>
                    <p class="eyebrow">Resumo</p>
                    <h3>Comparacoes</h3>
                </div>
            </div>
            <div class="summary-compare">
                <div class="pill ghost"><span class="dot low"></span> Mais barato: {{ melhor_fornecedor_total.nome if melhor_fornecedor_total else '-' }}</div>
                <div class="pill ghost"><span class="dot high"></span> Mais caro: {{ pior_fornecedor_total.nome if pior_fornecedor_total else '-' }}</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
