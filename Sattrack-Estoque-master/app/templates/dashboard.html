{% extends "base.html" %}
{% block title %}Painel{% endblock %}
{% block content %}
<div class="grid stats">
    <div class="card stat-card">
        <p class="stat-label">Total de Itens</p>
        <div class="stat-value">{{ total_itens }}</div>
    </div>
    <div class="card stat-card">
        <p class="stat-label">Quantidade em Estoque</p>
        <div class="stat-value">{{ total_quantidade }}</div>
    </div>
    <div class="card stat-card">
        <p class="stat-label">Valor Total</p>
        <div class="stat-value">R$ {{ "%.2f"|format(valor_total) }}</div>
        <p class="stat-sub">Inventario calculado pela ultima entrada</p>
    </div>
    <div class="card stat-card">
        <p class="stat-label">Movimentacoes Hoje</p>
        <div class="stat-value">{{ movimentacoes_hoje }}</div>
        <p class="stat-sub">Itens com estoque baixo: {{ estoque_baixo }}</p>
    </div>
</div>

<div class="grid three">
    <div class="card">
        <div class="card-header">Estoque por Item</div>
        <div class="chart-container"><canvas id="chart-estoque"></canvas></div>
    </div>
    <div class="card">
        <div class="card-header">Entradas vs Saidas (7 dias)</div>
        <div class="chart-container"><canvas id="chart-fluxo"></canvas></div>
    </div>
    <div class="card">
        <div class="card-header">Volume por Categoria</div>
        <div class="chart-container"><canvas id="chart-categorias"></canvas></div>
    </div>
</div>

<div class="grid two">
    <div class="card">
        <div class="card-header">Ultimas Entradas</div>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Item</th><th>Qtd</th><th>Usuario</th><th>Data</th>
                    </tr>
                </thead>
                <tbody>
                {% for e in ultimas_entradas %}
                    <tr>
                        <td>{{ e.item.descricao if e.item else e.item_id }}</td>
                        <td>{{ e.quantidade }}</td>
                        <td>{{ e.usuario }}</td>
                        <td>{{ e.created_at|datetime }}</td>
                    </tr>
                {% else %}
                    <tr><td colspan="4">Nenhuma entrada.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card">
        <div class="card-header">Ultimas Saidas</div>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Item</th><th>Qtd</th><th>Usuario</th><th>Data</th>
                    </tr>
                </thead>
                <tbody>
                {% for s in ultimas_saidas %}
                    <tr>
                        <td>{{ s.item.descricao if s.item else s.item_id }}</td>
                        <td>{{ s.quantidade }}</td>
                        <td>{{ s.usuario }}</td>
                        <td>{{ s.created_at|datetime }}</td>
                    </tr>
                {% else %}
                    <tr><td colspan="4">Nenhuma saida.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function loadCharts() {
    const estoque = await fetch('/api/dashboard/estoque').then(r => r.json());
    const fluxo = await fetch('/api/dashboard/fluxo').then(r => r.json());
    const categorias = await fetch('/api/dashboard/categorias').then(r => r.json());

    new Chart(document.getElementById('chart-estoque'), {
        type: 'bar',
        data: {
            labels: estoque.labels,
            datasets: [{
                label: 'Quantidade',
                data: estoque.quantidades,
                backgroundColor: '#3b82f6',
                borderRadius: 8,
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
        }
    });

    new Chart(document.getElementById('chart-fluxo'), {
        type: 'line',
        data: {
            labels: fluxo.labels,
            datasets: [
                {
                    label: 'Entradas',
                    data: fluxo.entradas,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59,130,246,0.18)',
                    fill: true,
                    tension: 0.25,
                },
                {
                    label: 'Saidas',
                    data: fluxo.saidas,
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239,68,68,0.16)',
                    fill: true,
                    tension: 0.25,
                }
            ]
        },
        options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            scales: { y: { beginAtZero: true } }
        }
    });

    new Chart(document.getElementById('chart-categorias'), {
        type: 'doughnut',
        data: {
            labels: categorias.labels,
            datasets: [{
                data: categorias.quantidades,
                backgroundColor: ['#3b82f6', '#22c55e', '#f59e0b', '#8b5cf6', '#06b6d4', '#ef4444'],
            }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
}
loadCharts();
</script>
{% endblock %}
