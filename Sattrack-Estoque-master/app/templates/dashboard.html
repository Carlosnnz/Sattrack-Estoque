{% extends "base.html" %}
{% block title %}Painel{% endblock %}
{% block content %}
<div class="grid stats">
    <div class="card stat-card">
        <p class="stat-label" style="display:flex;align-items:center;gap:8px;font-weight:700;font-size:16px;">
            <i class="fi fi-rr-box"></i><span>Total de Itens</span>
        </p>
        <div class="stat-value">{{ total_itens }}</div>
    </div>
    <div class="card stat-card">
        <p class="stat-label" style="display:flex;align-items:center;gap:8px;font-weight:700;font-size:16px;">
            <i class="fi fi-rr-layers"></i><span>Quantidade em Estoque</span>
        </p>
        <div class="stat-value">{{ total_quantidade }}</div>
    </div>
    <div class="card stat-card">
        <p class="stat-label" style="display:flex;align-items:center;gap:8px;font-weight:700;font-size:16px;">
            <i class="fi fi-rr-coin"></i><span>Valor Total</span>
        </p>
        <div class="stat-value">{{ valor_total|real }}</div>
        <p class="stat-sub">Inventário calculado pela última entrada</p>
    </div>
    <div class="card stat-card">
        <p class="stat-label" style="display:flex;align-items:center;gap:8px;font-weight:700;font-size:16px;">
            <i class="fi fi-rr-time-fast"></i><span>Movimentações Hoje</span>
        </p>
        <div class="stat-value">{{ movimentacoes_hoje }}</div>
        <p class="stat-sub">Itens com estoque baixo: {{ estoque_baixo }}</p>
    </div>
</div>

<div class="grid three">
    <div class="card">
        <div class="card-header">Estoque por Item</div>
        <div class="chart-container"><canvas id="chart-estoque"></canvas></div>
    </div>
    <div class="card">
        <div class="card-header">Entradas vs Saídas (7 dias)</div>
        <div class="chart-container"><canvas id="chart-fluxo"></canvas></div>
    </div>
    <div class="card">
        <div class="card-header">Volume por Categoria</div>
        <div class="chart-container"><canvas id="chart-categorias"></canvas></div>
    </div>
</div>

<div class="grid two">
    <div class="card">
        <div class="card-header">Últimas Entradas</div>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Item</th><th>Qtd</th><th>Usuário</th><th>Data</th>
                    </tr>
                </thead>
                <tbody>
                {% for e in ultimas_entradas %}
                    <tr>
                        <td>{{ e.item.descricao if e.item else e.item_id }}</td>
                        <td>{{ e.quantidade }}</td>
                        <td>{{ e.usuario }}</td>
                        <td>{{ e.created_at|datetime }}</td>
                    </tr>
                {% else %}
                    <tr><td colspan="4">Nenhuma entrada.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card">
        <div class="card-header">Últimas Saídas</div>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Item</th><th>Qtd</th><th>Usuário</th><th>Data</th>
                    </tr>
                </thead>
                <tbody>
                {% for s in ultimas_saidas %}
                    <tr>
                        <td>{{ s.item.descricao if s.item else s.item_id }}</td>
                        <td>{{ s.quantidade }}</td>
                        <td>{{ s.usuario }}</td>
                        <td>{{ s.created_at|datetime }}</td>
                    </tr>
                {% else %}
                    <tr><td colspan="4">Nenhuma saída.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>



<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function loadCharts() {
    const root = document.documentElement;
    const getVar = (name, fallback) => (getComputedStyle(root).getPropertyValue(name) || "").trim() || fallback;
    const isDark = (root.getAttribute("data-theme") || "").toLowerCase() === "dark";
    const colors = {
        primary: '#2563eb',
        primaryAccent: '#3b82f6',
        red: '#ef4444',
        text: getVar('--text', '#111827'),
        muted: getVar('--muted', '#4b5563'),
        grid: isDark ? 'rgba(255,255,255,0.08)' : 'rgba(15,23,42,0.08)',
        tooltipBg: isDark ? '#0b1220' : '#0f172a'
    };

    const estoque = await fetch('/api/dashboard/estoque').then(r => r.json());
    const fluxo = await fetch('/api/dashboard/fluxo').then(r => r.json());
    const categorias = await fetch('/api/dashboard/categorias').then(r => r.json());

    const estoqueData = (estoque.labels || []).map((label, idx) => ({
        label,
        value: estoque.quantidades?.[idx] ?? 0
    })).sort((a, b) => b.value - a.value);

    const totalEstoque = estoqueData.reduce((sum, item) => sum + item.value, 0);
    const baseHeight = 360;
    const estoqueHeight = Math.min(Math.max(estoqueData.length * 22, baseHeight), 520);
    document.querySelectorAll('.chart-container').forEach(el => { el.style.height = `${estoqueHeight}px`; });

    const estoqueCtx = document.getElementById('chart-estoque').getContext('2d');
    const estoqueGradient = estoqueCtx.createLinearGradient(0, 0, estoqueCtx.canvas.clientWidth || 420, 0);
    estoqueGradient.addColorStop(0, colors.primary);
    estoqueGradient.addColorStop(1, colors.primaryAccent);

    new Chart(estoqueCtx, {
        type: 'bar',
        data: {
            labels: estoqueData.map(d => d.label),
            datasets: [{
                label: 'Quantidade em estoque',
                data: estoqueData.map(d => d.value),
                backgroundColor: estoqueGradient,
                borderColor: '#1d4ed8',
                borderWidth: 1,
                borderRadius: 8,
                maxBarThickness: 22,
                barPercentage: 0.75,
                categoryPercentage: 0.75,
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 900, easing: 'easeOutCubic' },
            layout: { padding: { top: 6, bottom: 6, right: 8 } },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: colors.tooltipBg,
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    callbacks: {
                        label: (ctx) => {
                            const value = ctx.raw ?? 0;
                            const share = totalEstoque ? ((value / totalEstoque) * 100).toFixed(1) : 0;
                            return `${value} em estoque (${share}%)`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: { precision: 0, color: colors.muted },
                    grid: { color: colors.grid, drawBorder: false }
                },
                y: {
                    ticks: { autoSkip: false, padding: 6, color: colors.text },
                    grid: { display: false }
                }
            }
        }
    });

    const fluxoCtx = document.getElementById('chart-fluxo').getContext('2d');
    const fluxoGradientEntradas = fluxoCtx.createLinearGradient(0, 0, 0, fluxoCtx.canvas.height || 280);
    fluxoGradientEntradas.addColorStop(0, 'rgba(37,99,235,0.28)');
    fluxoGradientEntradas.addColorStop(1, 'rgba(37,99,235,0.04)');
    const fluxoGradientSaidas = fluxoCtx.createLinearGradient(0, 0, 0, fluxoCtx.canvas.height || 280);
    fluxoGradientSaidas.addColorStop(0, 'rgba(239,68,68,0.25)');
    fluxoGradientSaidas.addColorStop(1, 'rgba(239,68,68,0.04)');

    new Chart(fluxoCtx, {
        type: 'line',
        data: {
            labels: fluxo.labels,
            datasets: [
                {
                    label: 'Entradas',
                    data: fluxo.entradas,
                    borderColor: colors.primaryAccent,
                    backgroundColor: fluxoGradientEntradas,
                    fill: true,
                    tension: 0.32,
                    borderWidth: 2.5,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#ffffff',
                    pointBorderColor: colors.primaryAccent,
                    pointBorderWidth: 2,
                },
                {
                    label: 'Saidas',
                    data: fluxo.saidas,
                    borderColor: colors.red,
                    backgroundColor: fluxoGradientSaidas,
                    fill: true,
                    tension: 0.32,
                    borderWidth: 2.5,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#ffffff',
                    pointBorderColor: colors.red,
                    pointBorderWidth: 2,
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            layout: { padding: { top: 10, right: 6, left: 4, bottom: 4 } },
            plugins: {
                legend: {
                    position: 'top',
                    labels: { usePointStyle: true, boxWidth: 10, color: colors.text }
                },
                tooltip: { backgroundColor: colors.tooltipBg, titleColor: '#fff', bodyColor: '#fff' }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { precision: 0, color: colors.muted },
                    grid: { color: colors.grid, drawBorder: false }
                },
                x: {
                    ticks: { color: colors.muted },
                    grid: { display: false, drawBorder: false }
                }
            }
        }
    });

    const categoriasTotal = (categorias.quantidades || []).reduce((sum, val) => sum + (val || 0), 0);
    const centerText = {
        id: 'doughnutCenterText',
        afterDraw(chart, args, opts) {
            const { ctx } = chart;
            const meta = chart.getDatasetMeta(0);
            if (!meta.data.length) return;
            const { x, y } = meta.data[0].getProps(['x', 'y'], true);
            ctx.save();
            ctx.fillStyle = colors.text;
            ctx.textAlign = 'center';
            ctx.font = '700 14px "Inter","Poppins",system-ui';
            ctx.fillText('Total', x, y - 6);
            ctx.font = '700 18px "Inter","Poppins",system-ui';
            ctx.fillText(opts.value, x, y + 14);
            ctx.restore();
        }
    };

    new Chart(document.getElementById('chart-categorias'), {
        type: 'doughnut',
        plugins: [centerText],
        data: {
            labels: categorias.labels,
            datasets: [{
                data: categorias.quantidades,
                backgroundColor: ['#3b82f6', '#22c55e', '#f59e0b', '#8b5cf6', '#06b6d4', '#ef4444'],
                borderWidth: 2,
                borderColor: '#ffffff',
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '68%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { usePointStyle: true, boxWidth: 10, color: colors.text }
                },
                tooltip: {
                    backgroundColor: colors.tooltipBg,
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    callbacks: {
                        label: (ctx) => {
                            const value = ctx.raw ?? 0;
                            const share = categoriasTotal ? ((value / categoriasTotal) * 100).toFixed(1) : 0;
                            return `${ctx.label}: ${value} (${share}%)`;
                        }
                    }
                },
                doughnutCenterText: { value: categoriasTotal }
            }
        }
    });
}
loadCharts();
</script>

{% endblock %}
