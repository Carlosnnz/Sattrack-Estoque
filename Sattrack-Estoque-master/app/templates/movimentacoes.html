{% extends "base.html" %}
{% block title %}Movimentações{% endblock %}
{% block content %}
<div class="card">
        <div class="card-header">Nova Compra</div>
        <form action="/compras/criar" method="post" enctype="multipart/form-data" class="form-grid">
            <label>Fornecedor
                <select name="fornecedor" required>
                    <option value="">Selecione</option>
                    {% for f in fornecedores_options %}
                        <option value="{{ f }}">{{ f }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>Item<input name="item_nome" required></label>
            <input type="hidden" name="destino" id="destino_compra_hidden">
            <label>Filial
                <select id="filial_compra_select">
                    <option value="">Selecione</option>
                    {% for f in filiais_options %}
                        <option value="{{ f }}">{{ f }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>Setor
                <select id="setor_compra_select">
                    <option value="">Selecione</option>
                    {% for s in setores_options %}
                        <option value="{{ s }}">{{ s }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>Destinatário<input name="destinatario" required></label>
            <label>Quantidade<input type="number" name="quantidade" min="1" value="1" required></label>
            <label>Custo Unitário<input type="number" step="0.01" name="custo_unitario" required></label>
            <label>Data do Pedido<input type="date" name="data_pedido"></label>
            <label>Status
                <select name="status" required>
                    <option value="pendente">Pendente</option>
                    <option value="enviado">A Caminho</option>
                    <option value="entregue">Entregue</option>
                </select>
            </label>
            <label>Nota Fiscal<input type="file" name="nota_fiscal" accept=".pdf,.jpg,.jpeg,.png"></label>
            <label>Foto<input type="file" name="foto" accept=".jpg,.jpeg,.png"></label>
            <button class="btn" type="submit">Salvar compra</button>
        </form>
</div>
<script>
    (function() {
        const filial = document.getElementById('filial_compra_select');
        const setor = document.getElementById('setor_compra_select');
        const hidden = document.getElementById('destino_compra_hidden');
        function sync() {
            hidden.value = [filial.value, setor.value].filter(Boolean).join(' / ');
        }
        if (filial && setor && hidden) {
            filial.addEventListener('change', sync);
            setor.addEventListener('change', sync);
            sync();
        }
    })();
</script>

    <div class="card">
        <div class="card-header">Filtros</div>
        <form method="get" action="/movimentacoes/entradas" class="filters-grid">
            <label>Tipo
                <select name="tipo">
                <option value="" {% if not filtro_tipo %}selected{% endif %}>Todos</option>
                <option value="compra" {% if filtro_tipo=='compra' %}selected{% endif %}>Compra</option>
                <option value="entrada_manual" {% if filtro_tipo=='entrada_manual' %}selected{% endif %}>Entrada Manual</option>
                <option value="entrada_automatica" {% if filtro_tipo=='entrada_automatica' %}selected{% endif %}>Entrada Automática</option>
            </select>
        </label>
        <label>Fornecedor
            <select name="fornecedor">
                <option value="" {% if not filtro_fornecedor %}selected{% endif %}>Todos</option>
                {% for f in fornecedores_options %}
                    <option value="{{ f }}" {% if filtro_fornecedor==f %}selected{% endif %}>{{ f }}</option>
                {% endfor %}
            </select>
        </label>
        <label>Item<input name="item" value="{{ filtro_item }}"></label>
        <label>Status
            <select name="status">
                <option value="" {% if not filtro_status %}selected{% endif %}>Todos</option>
                <option value="pendente" {% if filtro_status=='pendente' %}selected{% endif %}>Pendente</option>
                <option value="enviado" {% if filtro_status=='enviado' %}selected{% endif %}>A Caminho</option>
                <option value="entregue" {% if filtro_status=='entregue' %}selected{% endif %}>Entregue</option>
            </select>
        </label>
        <label>Destinatário<input name="destinatario" value="{{ filtro_destinatario }}"></label>
        <label>Data<input type="date" name="data" value="{{ filtro_data }}"></label>
        <div class="inline-actions">
            <button class="btn" type="submit">Filtrar</button>
            <a class="btn secondary" href="/movimentacoes/entradas">Limpar</a>
        </div>
    </form>
</div>

<div class="card">
    <div class="card-header">Movimentações</div>
    <div class="table-responsive">
        <table>
            <thead>
                <tr>
                    <th>Tipo</th><th>Item</th><th>Qtd</th><th>Destinatário</th><th>Usuário</th><th>Fornecedor</th><th>Custo</th><th>Data</th><th>Status</th><th>NF</th><th>Ações</th>
                </tr>
            </thead>
            <tbody>
            {% for mov in movimentos %}
                <tr>
                    <td><span class="pill blue">{{ mov.tipo }}</span></td>
                    <td>
                        {% if mov.foto %}<img src="{{ mov.foto }}" class="small-avatar" alt="foto">{% endif %}
                        {{ mov.item_nome }}
                    </td>
                    <td>{{ mov.quantidade }}</td>
                    <td>{{ mov.destinatario }}</td>
                    <td>{{ mov.usuario or '-' }}</td>
                    <td>{{ mov.fornecedor or '-' }}</td>
                    <td>R$ {{ "%.2f"|format(mov.custo or 0) }}</td>
                    <td>{{ mov.data_mov|datetime }}</td>
                    <td>
                        <span class="status-badge status-{{ mov.status }}">{{ mov.status }}</span>
                    </td>
                    <td>
                        {% if mov.nota_fiscal %}
                            <a href="{{ mov.nota_fiscal }}" target="_blank">Abrir</a>
                        {% else %}-{% endif %}
                    </td>
                    <td>
                        {% if mov.tipo == "Compra" %}
                            <details>
                                <summary>Editar</summary>
                                <form method="post" action="/compras/{{ mov.compra_id }}/editar" enctype="multipart/form-data" class="form-grid">
                                    <select name="fornecedor" required>
                                        <option value="">Selecione</option>
                                        {% for f in fornecedores_options %}
                                            <option value="{{ f }}" {% if mov.fornecedor==f %}selected{% endif %}>{{ f }}</option>
                                        {% endfor %}
                                    </select>
                                    <input name="item_nome" value="{{ mov.item_nome }}" required>
                                    <input name="destino" value="{{ mov.destino or '' }}">
                                    <input name="destinatario" value="{{ mov.destinatario }}" required>
                                    <input type="number" name="quantidade" value="{{ mov.quantidade }}" min="1" required>
                                    <input type="date" name="data_pedido">
                                    <input type="number" step="0.01" name="custo_unitario" value="{{ mov.custo or 0 }}" required>
                                    <select name="status">
                                        <option value="pendente" {% if mov.status=='pendente' %}selected{% endif %}>Pendente</option>
                                        <option value="enviado" {% if mov.status=='enviado' %}selected{% endif %}>A Caminho</option>
                                        <option value="entregue" {% if mov.status=='entregue' %}selected{% endif %}>Entregue</option>
                                    </select>
                                    <input type="file" name="nota_fiscal" accept=".pdf,.jpg,.jpeg,.png">
                                    <input type="file" name="foto" accept=".jpg,.jpeg,.png">
                                    <button class="btn" type="submit">Salvar</button>
                                </form>
                                <form method="post" action="/compras/{{ mov.compra_id }}/deletar" onsubmit="return confirm('Excluir compra?');">
                                    <button class="btn danger" type="submit">Excluir</button>
                                </form>
                            </details>
                        {% elif mov.tipo == "Entrada Manual" %}
                            <details>
                                <summary>Ações</summary>
                                <form method="post" action="/entradas/{{ mov.entrada_id }}/editar" enctype="multipart/form-data" class="form-grid">
                                    <input type="number" name="quantidade" value="{{ mov.quantidade }}" min="1" required>
                                    <input name="destinatario" value="{{ mov.destinatario }}" required>
                                    <input name="motivo" value="">
                                    <input type="number" step="0.01" name="custo_unitario" value="{{ mov.custo or 0 }}">
                                    <input type="file" name="nota_fiscal" accept=".pdf,.jpg,.jpeg,.png">
                                    <input type="file" name="foto" accept=".jpg,.jpeg,.png">
                                    <button class="btn" type="submit">Salvar</button>
                                </form>
                                <form method="post" action="/entradas/{{ mov.entrada_id }}/deletar" onsubmit="return confirm('Excluir entrada?');">
                                    <button class="btn danger" type="submit">Excluir</button>
                                </form>
                            </details>
                        {% else %}
                            <span class="badge">Visualização</span>
                        {% endif %}
                    </td>
                </tr>
            {% else %}
                <tr><td colspan="11">Nenhuma movimentação encontrada.</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
