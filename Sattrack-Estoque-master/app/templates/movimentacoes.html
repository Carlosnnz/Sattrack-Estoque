{% extends "base.html" %}
{% block title %}Movimentacoes{% endblock %}
{% block content %}
<div class="grid two">
    <div class="card">
        <div class="card-header">Nova Compra</div>
        <form action="/compras/criar" method="post" enctype="multipart/form-data" class="form-grid">
            <label>Fornecedor<input name="fornecedor" required></label>
            <label>Item<input name="item_nome" required></label>
            <label>Destino<input name="destino" placeholder="Setor/Filial"></label>
            <label>Destinatario<input name="destinatario" required></label>
            <label>Quantidade<input type="number" name="quantidade" min="1" value="1" required></label>
            <label>Custo Unitario<input type="number" step="0.01" name="custo_unitario" required></label>
            <label>Data do Pedido<input type="date" name="data_pedido"></label>
            <label>Status
                <select name="status" required>
                    <option value="pendente">Pendente</option>
                    <option value="enviado">A Caminho</option>
                    <option value="entregue">Entregue</option>
                </select>
            </label>
            <label>Nota Fiscal<input type="file" name="nota_fiscal" accept=".pdf,.jpg,.jpeg,.png"></label>
            <label>Foto<input type="file" name="foto" accept=".jpg,.jpeg,.png"></label>
            <button class="btn" type="submit">Salvar compra</button>
        </form>
    </div>
    <div class="card">
        <div class="card-header">Entrada Manual</div>
        <form action="/entradas/registrar" method="post" enctype="multipart/form-data" class="form-grid">
            <label>Item
                <select name="item_id" required>
                    <option value="">Selecione</option>
                    {% for it in itens %}
                        <option value="{{ it.id }}">{{ it.descricao }} ({{ it.codigo_interno }})</option>
                    {% endfor %}
                </select>
            </label>
            <label>Quantidade<input type="number" name="quantidade" min="1" value="1" required></label>
            <label>Destinatario<input name="destinatario" required></label>
            <label>Custo Unitario<input type="number" step="0.01" name="custo_unitario" value="0.0"></label>
            <label>Motivo<input name="motivo" placeholder="opcional"></label>
            <label>Nota Fiscal<input type="file" name="nota_fiscal" accept=".pdf,.jpg,.jpeg,.png"></label>
            <label>Foto<input type="file" name="foto" accept=".jpg,.jpeg,.png"></label>
            <button class="btn" type="submit">Registrar entrada</button>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header">Filtros</div>
    <form method="get" action="/movimentacoes/entradas" class="filters-grid">
        <label>Tipo
            <select name="tipo">
                <option value="" {% if not filtro_tipo %}selected{% endif %}>Todos</option>
                <option value="compra" {% if filtro_tipo=='compra' %}selected{% endif %}>Compra</option>
                <option value="entrada_manual" {% if filtro_tipo=='entrada_manual' %}selected{% endif %}>Entrada Manual</option>
                <option value="entrada_automatica" {% if filtro_tipo=='entrada_automatica' %}selected{% endif %}>Entrada Automatica</option>
            </select>
        </label>
        <label>Fornecedor<input name="fornecedor" value="{{ filtro_fornecedor }}"></label>
        <label>Item<input name="item" value="{{ filtro_item }}"></label>
        <label>Status
            <select name="status">
                <option value="" {% if not filtro_status %}selected{% endif %}>Todos</option>
                <option value="pendente" {% if filtro_status=='pendente' %}selected{% endif %}>Pendente</option>
                <option value="enviado" {% if filtro_status=='enviado' %}selected{% endif %}>A Caminho</option>
                <option value="entregue" {% if filtro_status=='entregue' %}selected{% endif %}>Entregue</option>
            </select>
        </label>
        <label>Destinatario<input name="destinatario" value="{{ filtro_destinatario }}"></label>
        <label>Data<input type="date" name="data" value="{{ filtro_data }}"></label>
        <div class="inline-actions">
            <button class="btn" type="submit">Filtrar</button>
            <a class="btn secondary" href="/movimentacoes/entradas">Limpar</a>
        </div>
    </form>
</div>

<div class="card">
    <div class="card-header">Movimentacoes</div>
    <div class="table-responsive">
        <table>
            <thead>
                <tr>
                    <th>Tipo</th><th>Item</th><th>Qtd</th><th>Destinatario</th><th>Usuario</th><th>Fornecedor</th><th>Custo</th><th>Data</th><th>Status</th><th>NF</th><th>Acoes</th>
                </tr>
            </thead>
            <tbody>
            {% for mov in movimentos %}
                <tr>
                    <td><span class="pill blue">{{ mov.tipo }}</span></td>
                    <td>
                        {% if mov.foto %}<img src="{{ mov.foto }}" class="small-avatar" alt="foto">{% endif %}
                        {{ mov.item_nome }}
                    </td>
                    <td>{{ mov.quantidade }}</td>
                    <td>{{ mov.destinatario }}</td>
                    <td>{{ mov.usuario or '-' }}</td>
                    <td>{{ mov.fornecedor or '-' }}</td>
                    <td>R$ {{ "%.2f"|format(mov.custo or 0) }}</td>
                    <td>{{ mov.data_mov|datetime }}</td>
                    <td>
                        <span class="status-badge status-{{ mov.status }}">{{ mov.status }}</span>
                    </td>
                    <td>
                        {% if mov.nota_fiscal %}
                            <a href="{{ mov.nota_fiscal }}" target="_blank">Abrir</a>
                        {% else %}-{% endif %}
                    </td>
                    <td>
                        {% if mov.tipo == "Compra" %}
                            <details>
                                <summary>Editar</summary>
                                <form method="post" action="/compras/{{ mov.compra_id }}/editar" enctype="multipart/form-data" class="form-grid">
                                    <input name="fornecedor" value="{{ mov.fornecedor }}" required>
                                    <input name="item_nome" value="{{ mov.item_nome }}" required>
                                    <input name="destino" value="{{ mov.destino or '' }}">
                                    <input name="destinatario" value="{{ mov.destinatario }}" required>
                                    <input type="number" name="quantidade" value="{{ mov.quantidade }}" min="1" required>
                                    <input type="date" name="data_pedido">
                                    <input type="number" step="0.01" name="custo_unitario" value="{{ mov.custo or 0 }}" required>
                                    <select name="status">
                                        <option value="pendente" {% if mov.status=='pendente' %}selected{% endif %}>Pendente</option>
                                        <option value="enviado" {% if mov.status=='enviado' %}selected{% endif %}>A Caminho</option>
                                        <option value="entregue" {% if mov.status=='entregue' %}selected{% endif %}>Entregue</option>
                                    </select>
                                    <input type="file" name="nota_fiscal" accept=".pdf,.jpg,.jpeg,.png">
                                    <input type="file" name="foto" accept=".jpg,.jpeg,.png">
                                    <button class="btn" type="submit">Salvar</button>
                                </form>
                                <form method="post" action="/compras/{{ mov.compra_id }}/deletar" onsubmit="return confirm('Excluir compra?');">
                                    <button class="btn danger" type="submit">Excluir</button>
                                </form>
                            </details>
                        {% elif mov.tipo == "Entrada Manual" %}
                            <details>
                                <summary>Acoes</summary>
                                <form method="post" action="/entradas/{{ mov.entrada_id }}/editar" enctype="multipart/form-data" class="form-grid">
                                    <input type="number" name="quantidade" value="{{ mov.quantidade }}" min="1" required>
                                    <input name="destinatario" value="{{ mov.destinatario }}" required>
                                    <input name="motivo" value="">
                                    <input type="number" step="0.01" name="custo_unitario" value="{{ mov.custo or 0 }}">
                                    <input type="file" name="nota_fiscal" accept=".pdf,.jpg,.jpeg,.png">
                                    <input type="file" name="foto" accept=".jpg,.jpeg,.png">
                                    <button class="btn" type="submit">Salvar</button>
                                </form>
                                <form method="post" action="/entradas/{{ mov.entrada_id }}/deletar" onsubmit="return confirm('Excluir entrada?');">
                                    <button class="btn danger" type="submit">Excluir</button>
                                </form>
                            </details>
                        {% else %}
                            <span class="badge">Visualizacao</span>
                        {% endif %}
                    </td>
                </tr>
            {% else %}
                <tr><td colspan="11">Nenhuma movimentacao encontrada.</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
